<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Success</title>
</head>
<body style="font-family:system-ui;padding:24px">
  <h1>Subscription successful 🎉</h1>
  <p id="msg">We’re enabling your access…</p>

  <script>
    (async function () {
      const params = new URLSearchParams(location.search);
      const session_id = params.get('session_id');
      const key = session_id ? 'linked_session_' + session_id : null;

      try {
        if (session_id && !localStorage.getItem(key)) {
          const resp = await fetch('/api/link-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            // same-origin fetch already στέλνει cookies. Αν σε άλλον subdomain, βάλε credentials:'include'
            body: JSON.stringify({ session_id })
          });

          if (!resp.ok) {
            // optional: δες γιατί απέτυχε
            const text = await resp.text().catch(() => '');
            console.warn('link-session failed:', resp.status, text);
          } else {
            localStorage.setItem(key, '1');
          }

          // προαιρετικό μικρό delay (βοηθάει σε αργά δίκτυα)
          await new Promise(r => setTimeout(r, 500));
        }
      } catch (e) {
        console.warn('link-session error:', e);
      } finally {
        // Αποφυγή back-button loops + επιστροφή στην αρχική
        location.replace('/');
      }
    })();
  </script>
</body>
</html>

