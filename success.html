<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Success</title>
</head>
<body style="font-family:system-ui;padding:24px">
  <h1>Subscription successful ğŸ‰</h1>
  <p id="msg">Weâ€™re enabling your accessâ€¦</p>

  <script>
    (async function () {
      const params = new URLSearchParams(location.search);
      const session_id = params.get('session_id');
      const key = session_id ? 'linked_session_' + session_id : null;

      try {
        if (session_id && !localStorage.getItem(key)) {
          const resp = await fetch('/api/link-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            // same-origin fetch already ÏƒÏ„Î­Î»Î½ÎµÎ¹ cookies. Î‘Î½ ÏƒÎµ Î¬Î»Î»Î¿Î½ subdomain, Î²Î¬Î»Îµ credentials:'include'
            body: JSON.stringify({ session_id })
          });

          if (!resp.ok) {
            // optional: Î´ÎµÏ‚ Î³Î¹Î±Ï„Î¯ Î±Ï€Î­Ï„Ï…Ï‡Îµ
            const text = await resp.text().catch(() => '');
            console.warn('link-session failed:', resp.status, text);
          } else {
            localStorage.setItem(key, '1');
          }

          // Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÏŒ Î¼Î¹ÎºÏÏŒ delay (Î²Î¿Î·Î¸Î¬ÎµÎ¹ ÏƒÎµ Î±ÏÎ³Î¬ Î´Î¯ÎºÏ„Ï…Î±)
          await new Promise(r => setTimeout(r, 500));
        }
      } catch (e) {
        console.warn('link-session error:', e);
      } finally {
        // Î‘Ï€Î¿Ï†Ï…Î³Î® back-button loops + ÎµÏ€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î·Î½ Î±ÏÏ‡Î¹ÎºÎ®
        location.replace('/');
      }
    })();
  </script>
</body>
</html>

